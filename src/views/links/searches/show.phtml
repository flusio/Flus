<?php
    $this->layout('base.phtml', [
        'title' => _('New'),
        'canonical' => url_full('show search link'),
        'current_page' => 'search link',
        'back_options' => [
            'reset' => true,
        ],
        'has_errors' => $form->isInvalid(),
    ]);

    $link = $form->existingLink();
    $feeds = $form->existingFeeds();
?>

<div class="section">
    <div class="section__title">
        <h1 id="modal-title"><?= _('New') ?></h1>
    </div>

    <form
        method="post"
        action="<?= url('search link') ?>"
        <?php if ($form->autosubmit): ?>
             data-controller="autosubmit"
             data-autosubmit-mode-value="timeout"
             data-autosubmit-timeout-value="0"
        <?php endif; ?>
    >
        <?= $this->include('alerts/_error.phtml', ['message' => $form->error('@base')]) ?>

        <div class="form-group">
            <label for="url">
                <?= _('What’s the address of the link or feed?') ?>
            </label>

            <?php if ($form->isInvalid('url')): ?>
                <p id="url-error" class="form-group__error">
                    <?= _('Error:') ?>
                    <?= $form->error('url') ?>
                </p>
            <?php endif; ?>

            <div class="form-group__stack">
                <input
                    id="url"
                    name="url"
                    type="url"
                    placeholder="https://…"
                    required
                    value="<?= protect($form->url) ?>"
                    autocomplete="off"
                    <?php if ($form->isInvalid('url')): ?>
                        aria-errormessage="url-error"
                        aria-invalid="true"
                    <?php endif; ?>
                />

                <button
                    type="submit"
                    class="button--primary no-mobile"
                    data-autosubmit-target="actionButton"
                >
                    <?= _('Search') ?>
                </button>
            </div>
        </div>

        <div class="form__actions only-mobile">
            <button type="submit" class="button--primary">
                <?= _('Search') ?>
            </button>
        </div>

        <input type="hidden" name="csrf_token" value="<?= csrf_token($form) ?>" />
    </form>

    <?php if ($link): ?>
        <div class="cards cards--centered">
            <?= $this->include('links/_link.phtml', [
                'link' => $link,
                'display_published_at' => false,
                'display_notes' => true,
                'display_edit' => true,
                'display_repair' => true,
                'display_delete' => true,
                'display_read_later' => 'auto',
                'display_mark_as_read' => 'auto',
            ]); ?>

            <?php foreach ($feeds as $feed): ?>
                <div class="card card--illustrated" style="background-image: url('<?= url_media('covers', $feed->image_filename, 'collection-card.svg') ?>');">
                    <a class="card__body card__body--larger" href="<?= url('collection', ['id' => $feed->id]) ?>">
                        <div class="card__title card__title-ellipsis">
                            <?= protect($feed->name) ?>
                        </div>

                        <p class="card__text card__text--oneline">
                            <?php
                                $source = _f('Feed %s', protect($feed->feedWebsite()));

                                if ($feed->number_links === 0):
                                    $number_links = _('no links');
                                else:
                                    $number_links = _nf('%s link', '%s links', $feed->number_links, format_number($feed->number_links));
                                endif;
                            ?>

                            <span class="card__ellipsis"><?= $source ?></span>&nbsp;·&nbsp;<?= $number_links ?>

                            <p class="card__text" title="<?= _('Publication frequency') ?>">
                                <?= icon('line-chart') ?>
                                <?= format_publication_frequency($feed->publication_frequency_per_year) ?>
                            </p>
                        </p>
                    </a>

                    <div class="card__footer card__footer--centered">
                        <?php if ($current_user->isFollowing($feed->id)): ?>
                            <form data-turbo-preserve-scroll method="post" action="<?= url('unfollow collection', ['id' => $feed->id]) ?>">
                                <button>
                                    <?= icon('feed-stop') ?>
                                    <?= _('Unfollow') ?>
                                </button>

                                <input type="hidden" name="csrf_token" value="<?= csrf_token('collections\\UnfollowCollection') ?>" />
                            </form>
                        <?php else: ?>
                            <form data-turbo-preserve-scroll method="post" action="<?= url('follow collection', ['id' => $feed->id]) ?>">
                                <button>
                                    <?= icon('feed') ?>
                                    <?= _('Follow') ?>
                                </button>

                                <input type="hidden" name="csrf_token" value="<?= csrf_token('collections\\FollowCollection') ?>" />
                            </form>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    <?php endif; ?>

    <?php if (!$link && !$feeds): ?>
        <img
            class="illustration illustration--centered"
            alt=""
            src="<?= url_static('illustrations/location-search.svg') ?>"
            height="250"
        />
    <?php endif; ?>
</div>
